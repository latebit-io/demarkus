name: Auto Release

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]

permissions:
  contents: write

jobs:
  detect-and-tag:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    outputs:
      protocol: ${{ steps.bump.outputs.protocol }}
      server: ${{ steps.bump.outputs.server }}
      client: ${{ steps.bump.outputs.client }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version bumps
        id: bump
        run: |
          bump_module() {
            local module=$1

            # Find the latest tag for this module
            local latest_tag=$(git tag -l "${module}/v*" --sort=-v:refname | head -1)
            local current_version="0.0.0"
            if [ -n "$latest_tag" ]; then
              current_version="${latest_tag#${module}/v}"
            fi

            # Get commits since last tag (or all commits if no tag)
            local range="HEAD"
            if [ -n "$latest_tag" ]; then
              range="${latest_tag}..HEAD"
            fi

            # Check for conventional commits scoped to this module
            local has_breaking=false
            local has_feat=false
            local has_fix=false

            while IFS= read -r msg; do
              [ -z "$msg" ] && continue
              # Match commits scoped to this module or unscoped commits that touch module files
              if echo "$msg" | grep -qE "^[a-z]+(\(${module}\))?!:"; then
                has_breaking=true
              elif echo "$msg" | grep -qE "^feat(\(${module}\))?:"; then
                has_feat=true
              elif echo "$msg" | grep -qE "^fix(\(${module}\))?:"; then
                has_fix=true
              fi
            done < <(git log ${range} --pretty=format:"%s" -- "${module}/")

            # Also check unscoped commits that touch this module's files
            while IFS= read -r msg; do
              [ -z "$msg" ] && continue
              # Only match if no scope or scope matches
              if echo "$msg" | grep -qE "^[a-z]+!:" && ! echo "$msg" | grep -qE "^[a-z]+\("; then
                has_breaking=true
              elif echo "$msg" | grep -qE "^feat:" && ! echo "$msg" | grep -qE "^feat\("; then
                has_feat=true
              elif echo "$msg" | grep -qE "^fix:" && ! echo "$msg" | grep -qE "^fix\("; then
                has_fix=true
              fi
            done < <(git log ${range} --pretty=format:"%s" -- "${module}/")

            if ! $has_breaking && ! $has_feat && ! $has_fix; then
              echo ""
              return
            fi

            # Parse current version
            local major minor patch
            IFS='.' read -r major minor patch <<< "$current_version"

            # Bump version
            if $has_breaking; then
              if [ "$major" -eq 0 ]; then
                minor=$((minor + 1))
                patch=0
              else
                major=$((major + 1))
                minor=0
                patch=0
              fi
            elif $has_feat; then
              minor=$((minor + 1))
              patch=0
            elif $has_fix; then
              patch=$((patch + 1))
            fi

            echo "${major}.${minor}.${patch}"
          }

          protocol_version=$(bump_module "protocol")
          server_version=$(bump_module "server")
          client_version=$(bump_module "client")

          echo "protocol=${protocol_version}" >> "$GITHUB_OUTPUT"
          echo "server=${server_version}" >> "$GITHUB_OUTPUT"
          echo "client=${client_version}" >> "$GITHUB_OUTPUT"

          [ -n "$protocol_version" ] && echo "protocol → v${protocol_version}"
          [ -n "$server_version" ] && echo "server → v${server_version}"
          [ -n "$client_version" ] && echo "client → v${client_version}"
          [ -z "$protocol_version" ] && [ -z "$server_version" ] && [ -z "$client_version" ] && echo "No version bumps needed"

      - name: Create tags
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -n "${{ steps.bump.outputs.protocol }}" ]; then
            git tag "protocol/v${{ steps.bump.outputs.protocol }}"
            git push origin "protocol/v${{ steps.bump.outputs.protocol }}"
          fi
          if [ -n "${{ steps.bump.outputs.server }}" ]; then
            git tag "server/v${{ steps.bump.outputs.server }}"
            git push origin "server/v${{ steps.bump.outputs.server }}"
          fi
          if [ -n "${{ steps.bump.outputs.client }}" ]; then
            git tag "client/v${{ steps.bump.outputs.client }}"
            git push origin "client/v${{ steps.bump.outputs.client }}"
          fi
