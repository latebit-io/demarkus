name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      protocol: ${{ steps.filter.outputs.protocol }}
      server: ${{ steps.filter.outputs.server }}
      client: ${{ steps.filter.outputs.client }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            protocol:
              - 'protocol/**'
            server:
              - 'server/**'
              - 'protocol/**'
            client:
              - 'client/**'
              - 'protocol/**'

  test-protocol:
    needs: detect-changes
    if: needs.detect-changes.outputs.protocol == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.26"
      - run: cd protocol && go test ./...
      - run: cd protocol && go vet ./...

  test-server:
    needs: detect-changes
    if: needs.detect-changes.outputs.server == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.26"
      - run: cd server && go test ./...
      - run: cd server && go vet ./...
      - run: cd server && go build -o /dev/null ./cmd/demarkus-server

  test-client:
    needs: detect-changes
    if: needs.detect-changes.outputs.client == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.26"
      - run: cd client && go test ./...
      - run: cd client && go vet ./...
      - run: cd client && go build -o /dev/null ./cmd/demarkus

  semver-protocol:
    needs: test-protocol
    if: always() && needs.test-protocol.result == 'success'
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.semver.outputs.version }}
      should_release: ${{ steps.check.outputs.should_release }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: PaulHatch/semantic-version@v5.3.0
        id: semver
        with:
          tag_prefix: "protocol/v"
          major_pattern: "BREAKING CHANGE:"
          minor_pattern: "feat:"
          change_path: "protocol/"
          bump_each_commit: false
          search_commit_body: true
      - name: Check if version changed
        id: check
        run: |
          TAG="protocol/v${{ steps.semver.outputs.version }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "should_release=false" >> "$GITHUB_OUTPUT"
          else
            echo "should_release=true" >> "$GITHUB_OUTPUT"
          fi
          echo "Version: ${{ steps.semver.outputs.version }}, Tag exists: $(git rev-parse --verify "$TAG" 2>/dev/null && echo yes || echo no)"

  semver-server:
    needs: test-server
    if: always() && needs.test-server.result == 'success'
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.semver.outputs.version }}
      should_release: ${{ steps.check.outputs.should_release }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: PaulHatch/semantic-version@v5.3.0
        id: semver
        with:
          tag_prefix: "server/v"
          major_pattern: "BREAKING CHANGE:"
          minor_pattern: "feat:"
          change_path: "server/"
          bump_each_commit: false
          search_commit_body: true
      - name: Check if version changed
        id: check
        run: |
          TAG="server/v${{ steps.semver.outputs.version }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "should_release=false" >> "$GITHUB_OUTPUT"
          else
            echo "should_release=true" >> "$GITHUB_OUTPUT"
          fi
          echo "Version: ${{ steps.semver.outputs.version }}, Tag exists: $(git rev-parse --verify "$TAG" 2>/dev/null && echo yes || echo no)"

  semver-client:
    needs: test-client
    if: always() && needs.test-client.result == 'success'
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.semver.outputs.version }}
      should_release: ${{ steps.check.outputs.should_release }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: PaulHatch/semantic-version@v5.3.0
        id: semver
        with:
          tag_prefix: "client/v"
          major_pattern: "BREAKING CHANGE:"
          minor_pattern: "feat:"
          change_path: "client/"
          bump_each_commit: false
          search_commit_body: true
      - name: Check if version changed
        id: check
        run: |
          TAG="client/v${{ steps.semver.outputs.version }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "should_release=false" >> "$GITHUB_OUTPUT"
          else
            echo "should_release=true" >> "$GITHUB_OUTPUT"
          fi
          echo "Version: ${{ steps.semver.outputs.version }}, Tag exists: $(git rev-parse --verify "$TAG" 2>/dev/null && echo yes || echo no)"

  release-protocol:
    needs: semver-protocol
    if: needs.semver-protocol.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Create tag
        uses: actions/github-script@v7
        with:
          script: |
            const tag = 'protocol/v${{ needs.semver-protocol.outputs.new_version }}';
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${tag}`,
              sha: context.sha
            });
            console.log(`Created tag: ${tag}`);
      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = 'protocol/v${{ needs.semver-protocol.outputs.new_version }}';
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `Protocol ${{ needs.semver-protocol.outputs.new_version }}`,
              generate_release_notes: true
            });

  release-server:
    needs: semver-server
    if: needs.semver-server.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: "1.26"

      - name: Create module tag
        uses: actions/github-script@v7
        with:
          script: |
            const tag = 'server/v${{ needs.semver-server.outputs.new_version }}';
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${tag}`,
              sha: context.sha
            });
            console.log(`Created tag: ${tag}`);

      - name: Create local tag for GoReleaser
        run: git tag -f "v${{ needs.semver-server.outputs.new_version }}"

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean -f .goreleaser.yml
          workdir: server
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_CURRENT_TAG: "v${{ needs.semver-server.outputs.new_version }}"

  release-client:
    needs: semver-client
    if: needs.semver-client.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: "1.26"

      - name: Create module tag
        uses: actions/github-script@v7
        with:
          script: |
            const tag = 'client/v${{ needs.semver-client.outputs.new_version }}';
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${tag}`,
              sha: context.sha
            });
            console.log(`Created tag: ${tag}`);

      - name: Create local tag for GoReleaser
        run: git tag -f "v${{ needs.semver-client.outputs.new_version }}"

      - uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean -f .goreleaser.yml
          workdir: client
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_CURRENT_TAG: "v${{ needs.semver-client.outputs.new_version }}"
