name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      protocol: ${{ steps.filter.outputs.protocol }}
      server: ${{ steps.filter.outputs.server }}
      client: ${{ steps.filter.outputs.client }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            protocol:
              - 'protocol/**'
            server:
              - 'server/**'
              - 'protocol/**'
            client:
              - 'client/**'
              - 'protocol/**'

  test-protocol:
    needs: detect-changes
    if: needs.detect-changes.outputs.protocol == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.26"
      - name: Test
        run: cd protocol && go test ./...
      - name: Vet
        run: cd protocol && go vet ./...

  test-server:
    needs: detect-changes
    if: needs.detect-changes.outputs.server == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.26"
      - name: Test
        run: cd server && go test ./...
      - name: Vet
        run: cd server && go vet ./...
      - name: Build
        run: cd server && go build -o /dev/null ./cmd/demarkus-server

  test-client:
    needs: detect-changes
    if: needs.detect-changes.outputs.client == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.26"
      - name: Test
        run: cd client && go test ./...
      - name: Vet
        run: cd client && go vet ./...
      - name: Build CLI
        run: cd client && go build -o /dev/null ./cmd/demarkus
      - name: Build TUI
        run: cd client && go build -o /dev/null ./cmd/demarkus-tui
      - name: Build MCP
        run: cd client && go build -o /dev/null ./cmd/demarkus-mcp
